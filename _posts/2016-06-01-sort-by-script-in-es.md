---
layout:     post
title:      "搜索脚本排序"
date:       2016-06-01
author:     "秀川"
header-img: "img/post-bg-re-vs-ng2.jpg"
header-mask: 0.3
catalog:    true
tags:
    - 工作
    - 脚本
    - 搜索
    - 排序
    - ES
    - script
    - sort
    - 原创
---

# 搜索脚本排序
最近产品提了一个需求，要通过几个字段搜索出相应的结果，对结果要求按照特定的顺序排列。

## 需求
按照商品名称，车型，规格模糊搜索，商品名称的拼音简称也需要做模糊搜索，输入规则同商品名称

这3个字段的搜索条件需要连续，中间不存在空格，在字符串中间也需要匹配；

搜索结果排序，如果商品名称在第一个字符匹配以及中间匹配的文档，则第一个字符匹配的文档优先级高，排在前面；如果在中间匹配，那么按照匹配的字符串前面那段子串的字典序来排序；如果商品名称一致，则按照车型的字典序来匹配

## 解决方案
开始的时候考虑使用中文分词，对每个term进行拼音转换，再搜索，但是效果不是很好，有些词没有分出来，就查不出来了，按照拼音搜也不一定搜的出来，所以后来考虑使用前缀查询。

先对商品名称，商品名称拼音简称，车型，规格等转化成前缀数组，然后把数组内容放到同一个字段里面， 简称索引。

然后查询使用前缀查询，排序使用脚本，脚本如下：

	{
	  "query": {
	    "bool": {
	      "must": [
	        {
	          "term": {
	            "field1": "condition1"
	          }
	        },
	        {
	          "prefix": {
	            "search_field": "前保"
	          }
	        }
	      ],
	      "must_not": [],
	      "should": []
	    }
	  },
	  "from": 0,
	  "size": 1000,
	  "sort": [
	    {
	      "_script": {
	        "script": "doc['goodsNamePinyin'].value.indexOf('qb');",
	        "type": "number",
	        "order": "asc",
	        "score_mode": "replace"
	      }
	    },
	    {
	      "goodsName": "asc",
	      "carType": "asc"
	    }
	  ],
	  "aggs": {}
	}

ES中可以使用doc[fieldName]来获取到索引文档对象，doc[fieldName].value来获取文档的值，脚本用groovy语言，跟java很相似，此处我使用对拼音做查找，如果查询词转化成拼音简称A，再从拼音字符串中查找这个子串A的位置（这个位置就是用于排序的值），按照位置升序排序，这样如果是第一位就匹配的文档就肯定是排在前面的，然后再按照商品名称字典序升序排序，最后按照车型字典序升序排序。

## 存在问题
这么做也是会存在问题的

加入查询词在文档中间，文档开头的几个字符的拼音简写和查询词的相同，那么这个文档就相当于是被提升了排名，但是现阶段来看这个问题还不是很明显，毕竟数据量还不够大。